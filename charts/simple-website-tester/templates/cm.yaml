apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-cm
  namespace: {{ .Release.Namespace | quote }}
data:
  entrypoint.sh: |
    #!/bin/bash
    set -e

    # Need to wait to allow devspace.yaml script to catch up.
    sleep 5

    # Example:
    # url: example.com
    # plugins:
    #   downloader:
    #   - path: /
    #     fetch:
    #       - jpg
    #       - png
    # Will run /plugins/downloader.sh --url="example.com" --path="/" --fetch="jpg" --fetch="png"
    {{ if .Values.plugins }}
      {{- range $plugin, $pluginValues := .Values.plugins }}
        {{- if $pluginValues }}
          {{- range $commandIndex, $commandObject := $pluginValues }}
            /mnt/plugins/{{ $plugin }}.sh --url={{ $.Values.url | quote }}
            {{- range $commandKey, $commandValue := $commandObject -}}
              {{- if kindIs "slice" $commandValue }}
                {{- range $optionIndex, $optionObject := $commandValue }} --{{ $commandKey }}={{ $optionObject | quote }}{{ end -}}
              {{ else }} --{{ $commandKey }}={{ $commandValue | quote }}{{ end -}}
            {{- end -}}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
