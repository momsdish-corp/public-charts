apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-cm
  namespace: {{ .Release.Namespace | quote }}
data:
  entrypoint.sh: |
    #!/bin/bash
    set -e

    # Need to wait to allow devspace.yaml script to catch up.
    sleep 5

    # Values in .plugins.* are passed to the plugin as command line arguments.
    # Example:
    # plugins:
    #   downloader:
    #     - url: google.com
    #       fetch:
    #         - jpg
    #         - png
    # Will run /plugins/downloader.sh --url="google.com" --fetch="jpg" --fetch="png"
    {{ if .Values.plugins }}
      {{- range $plugin, $pluginValues := .Values.plugins }}
        {{- if $pluginValues }}
          {{- range $commandIndex, $commandObject := $pluginValues }}
            /mnt/plugins/{{ $plugin }}.sh
            {{- range $commandKey, $commandValue := $commandObject -}}
              {{- if kindIs "slice" $commandValue }}
                {{- range $optionIndex, $optionObject := $commandValue }} --{{ $commandKey }}={{ $optionObject }}{{ end -}}
              {{ else }} --{{ $commandKey }}={{ $commandValue | quote }}{{ end -}}
            {{- end -}}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
